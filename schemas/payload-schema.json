{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lorawan-schema.org/payload-schema/v1",
  "title": "LoRaWAN Payload Schema",
  "description": "Schema for defining LoRaWAN device payload codec descriptions",
  "type": "object",
  "definitions": {
    "field": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Field name in decoded output. Prefix with _ for internal/hidden fields."
        },
        "type": {
          "type": "string",
          "description": "Data type. Standard types or bitfield syntax (u8[3:4], bits<3,2>, etc.)"
        },
        "length": {
          "type": "integer",
          "minimum": 1,
          "description": "Byte length for bytes/string/hex/base64/bitfield_string/version_string types"
        },
        "consume": {
          "type": "integer",
          "minimum": 0,
          "description": "Bytes to advance after reading. 0 = don't advance (shared byte)."
        },
        "bit": {
          "type": "integer",
          "minimum": 0,
          "maximum": 7,
          "description": "Bit position for bool type"
        },
        "mult": {
          "type": "number",
          "description": "Multiply raw value by this factor"
        },
        "div": {
          "type": "number",
          "exclusiveMinimum": 0,
          "description": "Divide raw value by this factor"
        },
        "add": {
          "type": "number",
          "description": "Add this offset to raw value"
        },
        "formula": {
          "type": "string",
          "description": "Custom formula using 'x' for raw value and $field for cross-references"
        },
        "encode_formula": {
          "type": "string",
          "description": "Custom inverse formula for encoding (Phase 3)"
        },
        "unit": {
          "type": "string",
          "description": "Engineering unit (e.g., degC, %RH, mV)"
        },
        "valid_range": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 2,
          "maxItems": 2,
          "description": "Expected value bounds [min, max]. Out-of-range values produce quality warnings."
        },
        "resolution": {
          "type": "number",
          "exclusiveMinimum": 0,
          "description": "Minimum detectable change (e.g., 0.01 for 0.01Â°C steps)"
        },
        "unece": {
          "type": "string",
          "pattern": "^[A-Z0-9]{2,3}$",
          "description": "UNECE Recommendation 20 unit code (e.g., CEL for Celsius, FAH for Fahrenheit)"
        },
        "var": {
          "type": "string",
          "description": "Store decoded value as variable for later match/formula references"
        },
        "lookup": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Lookup table: index -> string value"
        },
        "values": {
          "description": "Enum values: dict {int: string} or list [string]"
        },
        "base": {
          "type": "string",
          "description": "Base integer type for enum (default: u8)"
        },
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/field"
          },
          "description": "Nested fields for object type"
        },
        "on": {
          "type": "string",
          "description": "Match discriminator field name (legacy syntax)"
        },
        "cases": {
          "description": "Match cases: legacy [{case:, fields:}] or Option B {value: [fields]}"
        },
        "default": {
          "description": "Default case behavior: 'error', 'skip', or {fields: [...]}"
        },
        "semantic": {
          "type": "object",
          "properties": {
            "ipso": {
              "type": "integer",
              "description": "IPSO Smart Object ID"
            },
            "senml": {
              "type": "string",
              "description": "SenML name"
            }
          },
          "description": "Semantic mapping for output formats"
        },
        "description": {
          "type": "string",
          "description": "Human-readable field description"
        },
        "parts": {
          "type": "array",
          "items": {
            "type": "array",
            "items": [
              {
                "type": "integer",
                "description": "Bit offset"
              },
              {
                "type": "integer",
                "description": "Bit length"
              }
            ]
          },
          "description": "Bitfield string parts: [[bitOffset, bitLength, format?], ...]"
        },
        "delimiter": {
          "type": "string",
          "description": "Delimiter for bitfield_string/version_string assembly"
        },
        "prefix": {
          "type": "string",
          "description": "Prefix for bitfield_string/version_string output"
        }
      },
      "additionalProperties": true
    }
  },
  "properties": {
    "name": {
      "type": "string",
      "description": "Schema name (typically device model)"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Schema version"
    },
    "endian": {
      "type": "string",
      "enum": [
        "big",
        "little"
      ],
      "default": "big",
      "description": "Default byte order"
    },
    "description": {
      "type": "string",
      "description": "Human-readable schema description"
    },
    "manufacturer": {
      "type": "string",
      "description": "Device manufacturer name"
    },
    "device": {
      "type": "string",
      "description": "Device model name"
    },
    "fields": {
      "type": "array",
      "minItems": 1,
      "description": "Field definitions (for single-port schemas)"
    },
    "ports": {
      "type": "object",
      "description": "Port-based field definitions: {port_number: {fields: [...]}}"
    },
    "definitions": {
      "type": "object",
      "description": "Reusable field group definitions for $ref"
    },
    "test_vectors": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "payload": {
            "description": "Hex string, byte array, or 0x-prefixed string"
          },
          "fport": {
            "type": "integer",
            "minimum": 1,
            "maximum": 255
          },
          "fPort": {
            "type": "integer",
            "minimum": 1,
            "maximum": 255
          },
          "expected": {
            "type": "object",
            "description": "Expected decoded field values"
          },
          "input_metadata": {
            "type": "object",
            "description": "TS013 input metadata for testing"
          }
        },
        "required": [
          "name",
          "payload",
          "expected"
        ]
      },
      "description": "Test cases for validation"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "include": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "source": {
                "type": "string",
                "description": "$ reference to TS013 input"
              }
            },
            "required": [
              "name",
              "source"
            ]
          }
        },
        "timestamps": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "mode": {
                "type": "string",
                "enum": [
                  "rx_time",
                  "subtract",
                  "unix_epoch",
                  "iso8601",
                  "elapsed_to_absolute"
                ]
              },
              "field": {
                "type": "string"
              },
              "offset_field": {
                "type": "string"
              },
              "elapsed_field": {
                "type": "string"
              },
              "time_base": {
                "type": "string"
              },
              "source": {
                "type": "string"
              },
              "format": {
                "type": "string",
                "description": "strftime format for iso8601 mode"
              }
            },
            "required": [
              "name"
            ]
          }
        }
      }
    }
  },
  "required": [
    "name"
  ],
  "anyOf": [
    {
      "required": [
        "fields"
      ]
    },
    {
      "required": [
        "ports"
      ]
    }
  ]
}
