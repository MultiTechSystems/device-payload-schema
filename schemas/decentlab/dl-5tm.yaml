# https://www.decentlab.com/products/legacy-soil-moisture-and-temperature-sensor-for-lorawan
name: decentlab_dl_5tm
version: 3
endian: big

fields:
  - name: protocol_version
    type: u8
  - name: device_id
    type: u16
  - name: flags
    type: u16

  - flagged:
      field: flags
      groups:
        - bit: 0
          fields:
            - name: dielectric_permittivity
              type: u16
              div: 50
            - name: volumetric_water_content
              type: number
              ref: $dielectric_permittivity
              polynomial: [0.0000043, -0.00055, 0.0292, -0.053]
              unit: "m³/m³"
            - name: soil_temperature_raw
              type: u16
            - name: soil_temperature
              type: number
              ref: $soil_temperature_raw
              transform:
                - add: -400
                - div: 10
              unit: "°C"
              ipso: {object: 3303, instance: 0, resource: 5700}
              senml: {name: "soil_temp", unit: "Cel"}
              semantic: "soil.temperature"
        - bit: 1
          fields:
            - name: battery_voltage
              type: u16
              div: 1000
              unit: "V"
              ipso: {object: 3316, instance: 0, resource: 5700}
              senml: {name: "vbat", unit: "V"}
              semantic: "battery.voltage"

test_vectors:
  - name: typical_reading
    description: "Typical soil moisture and temperature reading"
    payload: "02 1234 0003 01F4 0226 0C5E"
    expected:
      protocol_version: 2
      device_id: 0x1234
      flags: 3
      dielectric_permittivity: 10.0
      volumetric_water_content: 0.1883
      soil_temperature_raw: 550
      soil_temperature: 15.0
      battery_voltage: 3.166

  - name: dry_soil
    description: "Low moisture, cool temperature"
    payload: "02 ABCD 0003 0064 01C2 0BB8"
    expected:
      protocol_version: 2
      device_id: 0xABCD
      flags: 3
      dielectric_permittivity: 2.0
      volumetric_water_content: 0.0013
      soil_temperature_raw: 450
      soil_temperature: 5.0
      battery_voltage: 3.0

  - name: battery_only
    description: "Only battery group present (bit 1)"
    payload: "02 0001 0002 0FA0"
    expected:
      protocol_version: 2
      device_id: 1
      flags: 2
      battery_voltage: 4.0

  - name: sensor_only
    description: "Only sensor group present (bit 0)"
    payload: "02 5678 0001 0000 0190 "
    expected:
      protocol_version: 2
      device_id: 0x5678
      flags: 1
      dielectric_permittivity: 0.0
      volumetric_water_content: -0.053
      soil_temperature_raw: 400
      soil_temperature: 0.0

  - name: zero_values
    description: "Zero dielectric permittivity edge case"
    payload: "02 0000 0003 0000 0190 0000"
    expected:
      protocol_version: 2
      device_id: 0
      flags: 3
      dielectric_permittivity: 0.0
      volumetric_water_content: -0.053
      soil_temperature_raw: 400
      soil_temperature: 0.0
      battery_voltage: 0.0

  - name: max_values
    description: "Maximum values edge case"
    payload: "02 FFFF 0003 FFFF FFFF FFFF"
    expected:
      protocol_version: 2
      device_id: 0xFFFF
      flags: 3
      dielectric_permittivity: 1310.7
      soil_temperature_raw: 65535
      soil_temperature: 6513.5
      battery_voltage: 65.535

  - name: minimum_payload
    description: "Minimum valid payload (no flagged groups)"
    payload: "02 1234 0000"
    expected:
      protocol_version: 2
      device_id: 0x1234
      flags: 0
