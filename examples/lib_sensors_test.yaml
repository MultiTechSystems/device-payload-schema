# Test schema for schemas/library/sensors definitions
# Validates that library definitions work correctly with preprocessor and interpreter

name: lib_sensors_test
version: 1
endian: big
description: Test schema using schemas/library/sensors definitions

fields:
  # Environmental sensors
  - $ref: "schemas/library/sensors/environmental.yaml#/definitions/temperature_c_div10"
  - $ref: "schemas/library/sensors/environmental.yaml#/definitions/humidity_pct_half"
  - $ref: "schemas/library/sensors/environmental.yaml#/definitions/pressure_hpa_div10"
  - $ref: "schemas/library/sensors/environmental.yaml#/definitions/co2_ppm"
  
  # Power
  - $ref: "schemas/library/sensors/power.yaml#/definitions/battery_pct"
  
  # Distance
  - $ref: "schemas/library/sensors/distance.yaml#/definitions/distance_mm"
  
  # Motion (use pir_byte which consumes full byte)
  - $ref: "schemas/library/sensors/motion.yaml#/definitions/pir_byte"
  
  # Position (3-byte compact)
  - $ref: "schemas/library/sensors/position.yaml#/definitions/latitude_3byte"
  - $ref: "schemas/library/sensors/position.yaml#/definitions/longitude_3byte"

test_vectors:
  - name: normal_indoor
    description: "Normal indoor environmental reading"
    # temp=23.1 -> raw=231=0x00E7
    # hum=65% -> raw=130=0x82 (130*0.5=65)
    # pres=1013.2hPa -> raw=10132=0x2794
    # co2=800ppm -> raw=800=0x0320
    # battery=85% -> raw=85=0x55
    # distance=1500mm -> raw=1500=0x05DC
    # pir=true -> raw=1=0x01
    # lat=51.5074 -> raw=515074=0x07DC02 (s24)
    # lon=-0.1278 -> raw=-1278=0xFFFB02 (s24)
    payload: "00E7 82 2794 0320 55 05DC 01 07DC02 FFFB02"
    expected:
      temperature: 23.1
      humidity: 65.0
      pressure: 1013.2
      co2: 800
      battery: 85
      distance: 1500
      pir: 1
      latitude: 51.5074
      longitude: -0.1278

  - name: cold_outdoor
    description: "Cold outdoor with low battery"
    # temp=-10.0 -> raw=-100=0xFF9C
    # hum=80% -> raw=160=0xA0 (160*0.5=80)
    # pres=985.0hPa -> raw=9850=0x267A
    # co2=420ppm -> raw=420=0x01A4
    # battery=15% -> raw=15=0x0F
    # distance=5000mm -> raw=5000=0x1388
    # pir=false -> raw=0=0x00
    # lat=48.8566 -> raw=488566=0x077476 (s24)
    # lon=2.3522 -> raw=23522=0x005BE2 (s24)
    payload: "FF9C A0 267A 01A4 0F 1388 00 077476 005BE2"
    expected:
      temperature: -10.0
      humidity: 80.0
      pressure: 985.0
      co2: 420
      battery: 15
      distance: 5000
      pir: 0
      latitude: 48.8566
      longitude: 2.3522

  - name: quality_check
    description: "Values triggering out_of_range quality flags"
    # temp=150.0 (0x05DC) - above 125 max
    # hum=110% (0xDC=220*0.5) - above 100 max  
    # pres=1200.0hPa (0x2EE0) - above 1100 max
    # co2=6000ppm (0x1770) - above 5000 max
    # battery=100% (0x64) - valid
    # distance=0 (0x0000) - valid
    # pir=0, lat=0, lon=0
    payload: "05DC DC 2EE0 1770 64 0000 00 000000 000000"
    expected:
      temperature: 150.0
      humidity: 110.0
      pressure: 1200.0
      co2: 6000
      battery: 100
      distance: 0
      pir: 0
      latitude: 0.0
      longitude: 0.0
    expected_quality:
      temperature: "out_of_range"
      humidity: "out_of_range"
      pressure: "out_of_range"
      co2: "out_of_range"
      battery: "good"
      distance: "good"
