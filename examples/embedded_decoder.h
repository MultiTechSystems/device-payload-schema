/*
 * embedded_decoder.h - Example: Generic decoder with separate binary schema
 *
 * This pattern enables:
 * - Same decoder code across entire product line
 * - Schema stored in flash/EEPROM, updatable without reflash
 * - OTA schema updates without firmware changes
 * - ~2KB decoder + ~50 bytes per schema
 */

#ifndef EMBEDDED_DECODER_H
#define EMBEDDED_DECODER_H

#include "schema_interpreter.h"

/*
 * Application owns the schema storage location.
 * Could be in flash, EEPROM, received via OTA, etc.
 */
typedef struct {
    const uint8_t* schema_data;  /* Pointer to binary schema */
    size_t schema_len;
    schema_t parsed_schema;      /* Pre-parsed for fast decode */
    bool initialized;
} device_decoder_t;

/*
 * Initialize decoder with binary schema from any source
 */
static inline int decoder_init(device_decoder_t* dec, 
                               const uint8_t* schema, 
                               size_t schema_len) {
    dec->schema_data = schema;
    dec->schema_len = schema_len;
    
    int rc = schema_load_binary(&dec->parsed_schema, schema, schema_len);
    if (rc == SCHEMA_OK) {
        dec->initialized = true;
    }
    return rc;
}

/*
 * Decode payload using pre-parsed schema
 */
static inline int decoder_decode(const device_decoder_t* dec,
                                 const uint8_t* payload,
                                 size_t payload_len,
                                 decode_result_t* result) {
    if (!dec->initialized) {
        return SCHEMA_ERR_PARSE;
    }
    return schema_decode(&dec->parsed_schema, payload, payload_len, result);
}

/*
 * Example: Schema stored in flash
 */
#ifdef SCHEMA_IN_FLASH
/* Generated by: python schema_binary.py encode my_schema.yaml */
static const uint8_t MY_SCHEMA[] __attribute__((section(".rodata"))) = {
    0x50, 0x53, 0x01, 0x00, 0x04,  /* Header: PS v1, big-endian, 4 fields */
    0x12, 0xFE, 0xE7, 0x0C,        /* temperature: s16, mult=0.01 */
    0x01, 0x81, 0xE8, 0x0C,        /* humidity: u8, mult=0.5 */
    0x02, 0x00, 0xF4, 0x0C,        /* battery: u16 */
    0x01, 0x00, 0x00, 0x80,        /* status: u8 */
};
#define MY_SCHEMA_LEN sizeof(MY_SCHEMA)
#endif

/*
 * Example: Schema received via LoRaWAN downlink
 */
#ifdef SCHEMA_VIA_OTA
static uint8_t ota_schema_buffer[256];
static size_t ota_schema_len = 0;

static inline int decoder_update_schema(device_decoder_t* dec,
                                        const uint8_t* new_schema,
                                        size_t new_len) {
    if (new_len > sizeof(ota_schema_buffer)) {
        return -1;
    }
    memcpy(ota_schema_buffer, new_schema, new_len);
    ota_schema_len = new_len;
    return decoder_init(dec, ota_schema_buffer, ota_schema_len);
}
#endif

/*
 * Example: Schema in external EEPROM
 */
#ifdef SCHEMA_IN_EEPROM
#define EEPROM_SCHEMA_ADDR 0x100
#define EEPROM_SCHEMA_MAX  128

static uint8_t eeprom_schema_cache[EEPROM_SCHEMA_MAX];

static inline int decoder_load_from_eeprom(device_decoder_t* dec) {
    /* Read schema length from first byte */
    uint8_t len = eeprom_read_byte(EEPROM_SCHEMA_ADDR);
    if (len == 0 || len == 0xFF || len > EEPROM_SCHEMA_MAX) {
        return -1;
    }
    
    /* Read schema data */
    for (int i = 0; i < len; i++) {
        eeprom_schema_cache[i] = eeprom_read_byte(EEPROM_SCHEMA_ADDR + 1 + i);
    }
    
    return decoder_init(dec, eeprom_schema_cache, len);
}
#endif

/*
 * Usage example:
 *
 *   device_decoder_t decoder;
 *   decoder_init(&decoder, MY_SCHEMA, MY_SCHEMA_LEN);
 *   
 *   // In LoRaWAN receive callback:
 *   decode_result_t result;
 *   decoder_decode(&decoder, payload, len, &result);
 *   
 *   double temp = result_get_double(&result, "temperature", 0.0);
 *   double hum = result_get_double(&result, "humidity", 0.0);
 */

#endif /* EMBEDDED_DECODER_H */
