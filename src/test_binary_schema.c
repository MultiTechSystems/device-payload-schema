/*
 * test_binary_schema.c - Test binary schema loading in C interpreter
 *
 * Compile: gcc -O2 -I../include -o test_binary_schema test_binary_schema.c
 */

#include <stdio.h>
#include <string.h>
#include <time.h>
#include "schema_interpreter.h"

/* Binary schema generated by schema_binary.py:
 * name: test
 * fields:
 *   - name: temperature, type: s16, mult: 0.01
 *   - name: humidity, type: u8, mult: 0.5
 *   - name: battery, type: u16
 */
static const uint8_t binary_schema[] = {
    0x50, 0x53,       /* Magic: 'PS' */
    0x01,             /* Version: 1 */
    0x00,             /* Flags: big-endian */
    0x03,             /* Field count: 3 */
    
    /* Field 0: temperature (s16, mult=0.01) */
    0x12,             /* Type: SINT(1), Size: 2 */
    0xFE,             /* Mult exp: -2 -> 0.01 */
    0xE7, 0x0C,       /* Field ID: 3303 (temperature) */
    
    /* Field 1: humidity (u8, mult=0.5) */
    0x01,             /* Type: UINT(0), Size: 1 */
    0x81,             /* Mult exp: special 0.5 */
    0xE8, 0x0C,       /* Field ID: 3304 (humidity) */
    
    /* Field 2: battery (u16) */
    0x02,             /* Type: UINT(0), Size: 2 */
    0x00,             /* Mult exp: 0 -> 1.0 */
    0xF4, 0x0C,       /* Field ID: 3316 (voltage) */
};

void test_binary_loading(void) {
    printf("=== Binary Schema Loading Test ===\n\n");
    
    schema_t schema;
    int rc = schema_load_binary(&schema, binary_schema, sizeof(binary_schema));
    
    if (rc != SCHEMA_OK) {
        printf("Failed to load binary schema: %d\n", rc);
        return;
    }
    
    printf("Loaded schema: %d fields\n", schema.field_count);
    for (int i = 0; i < schema.field_count; i++) {
        field_def_t* f = &schema.fields[i];
        printf("  %s: type=%d, size=%d, mult=%g\n", 
               f->name, f->type, f->size, f->mult);
    }
    
    /* Decode test payload */
    /* temp=0x0929=2345 -> 23.45, hum=0x82=130 -> 65.0, bat=0x0CE4=3300 */
    uint8_t payload[] = {0x09, 0x29, 0x82, 0x0C, 0xE4};
    decode_result_t result;
    
    rc = schema_decode(&schema, payload, sizeof(payload), &result);
    
    if (rc != SCHEMA_OK) {
        printf("Decode failed: %d\n", rc);
        return;
    }
    
    printf("\nDecoded %d fields:\n", result.field_count);
    for (int i = 0; i < result.field_count; i++) {
        printf("  %s: %.2f\n", result.fields[i].name, result.fields[i].value.f64);
    }
    
    printf("\nExpected: temperature=23.45, humidity=65.0, voltage=3300.0\n");
}

void benchmark_binary_vs_programmatic(void) {
    printf("\n=== Benchmark: Binary vs Programmatic ===\n\n");
    
    /* Test payload */
    uint8_t payload[] = {0x09, 0x29, 0x82, 0x0C, 0xE4};
    decode_result_t result;
    int iterations = 10000000;
    
    /* Programmatic schema */
    schema_t prog_schema;
    schema_init(&prog_schema);
    strncpy(prog_schema.name, "programmatic", SCHEMA_MAX_NAME_LEN - 1);
    
    field_def_t f1 = field_s16("temperature", ENDIAN_BIG);
    field_set_mult(&f1, 0.01);
    schema_add_field(&prog_schema, &f1);
    
    field_def_t f2 = field_u8("humidity");
    field_set_mult(&f2, 0.5);
    schema_add_field(&prog_schema, &f2);
    
    field_def_t f3 = field_u16("battery", ENDIAN_BIG);
    schema_add_field(&prog_schema, &f3);
    
    /* Binary schema */
    schema_t bin_schema;
    schema_load_binary(&bin_schema, binary_schema, sizeof(binary_schema));
    
    /* Warmup */
    for (int i = 0; i < 1000; i++) {
        schema_decode(&prog_schema, payload, sizeof(payload), &result);
        schema_decode(&bin_schema, payload, sizeof(payload), &result);
    }
    
    /* Benchmark programmatic */
    clock_t start = clock();
    for (int i = 0; i < iterations; i++) {
        schema_decode(&prog_schema, payload, sizeof(payload), &result);
    }
    clock_t prog_time = clock() - start;
    double prog_us = (double)prog_time / CLOCKS_PER_SEC * 1e6 / iterations;
    
    /* Benchmark binary */
    start = clock();
    for (int i = 0; i < iterations; i++) {
        schema_decode(&bin_schema, payload, sizeof(payload), &result);
    }
    clock_t bin_time = clock() - start;
    double bin_us = (double)bin_time / CLOCKS_PER_SEC * 1e6 / iterations;
    
    printf("Iterations: %d\n", iterations);
    printf("Programmatic schema: %.4f µs/decode\n", prog_us);
    printf("Binary schema:       %.4f µs/decode\n", bin_us);
    printf("Difference: %.2f%%\n", (prog_us - bin_us) / prog_us * 100);
    
    /* Also benchmark schema loading time */
    printf("\nSchema loading (1000 iterations):\n");
    
    start = clock();
    for (int i = 0; i < 1000; i++) {
        schema_t s;
        schema_load_binary(&s, binary_schema, sizeof(binary_schema));
    }
    double load_us = (double)(clock() - start) / CLOCKS_PER_SEC * 1e6 / 1000;
    printf("Binary load: %.2f µs\n", load_us);
}

int main(void) {
    test_binary_loading();
    benchmark_binary_vs_programmatic();
    return 0;
}
